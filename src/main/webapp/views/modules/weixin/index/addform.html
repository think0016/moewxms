<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>${sitetitle!"MOE"}</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="${ctxroot}/static/bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="${ctxroot}/static/plugins/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="${ctxroot}/static/plugins/other/ionicons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="${ctxroot}/static/plugins/datatables/dataTables.bootstrap.css">
  <!-- ztree -->
  <link rel="stylesheet" href="${ctxroot}/static/plugins/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css">
  <!-- Alert -->
  <link rel="stylesheet" href="${ctxroot}/static/plugins/Alert/Alert.css">
    <!-- Theme style -->
  <link rel="stylesheet" href="${ctxroot}/static/dist/css/lqstyle.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="${ctxroot}/static/dist/css/admincore.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="${ctxroot}/static/dist/css/skins/_all-skins.min.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <style type="text/css">
    ul.ztree {margin-top: 10px;border: 1px solid #617775;background: #f0f6e4;width:220px;height:360px;overflow-y:scroll;overflow-x:auto;}
  </style>
  <script type="text/javascript">
  var rooturl = '${ctxroot}'; 
  var actionurl = rooturl + "/weixin"; 
  </script>
</head>
<body class="hold-transition skin-green-light sidebar-mini">
  <!-- Site wrapper -->
  <div class="wrapper">

    <header class="main-header">
      <!-- Logo -->
      <#include "/views/common/logo.html">
      <!-- Header Navbar: style can be found in header.less -->
      <nav class="navbar navbar-static-top">
        <!-- Sidebar toggle button-->
        <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>

        <div class="navbar-custom-menu">
          <ul class="nav navbar-nav">
            <!-- Messages: style can be found in dropdown.less-->

            <!-- Notifications: style can be found in dropdown.less -->

            <!-- Tasks: style can be found in dropdown.less -->

            <!-- User Account: style can be found in dropdown.less -->
            <#include "/views/common/userAccount.html">
            <!-- Control Sidebar Toggle Button --> </ul>
        </div>
      </nav>
    </header>

    <!-- =============================================== -->

    <!-- Left side column. contains the sidebar -->
    <aside class="main-sidebar">
      <!-- sidebar: style can be found in sidebar.less -->
      <section class="sidebar">

        <!-- sidebar menu: : style can be found in sidebar.less -->${menuhtml}</section>
      <!-- /.sidebar --> </aside>

    <!-- =============================================== -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <h1>公众号管理</h1>
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="row">
          <div class="col-md-1"></div>
          <div class="col-md-10">
            <!-- 提示框 START -->
            <#if errormsg??>
            <div class="alert alert-danger alert-dismissible">
              <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
              <h4> <i class="icon fa fa-ban"></i>
                发生错误!
              </h4>
              ${errormsg}
            </div>
          </#if>
          <#if infomsg??>
          <div class="alert alert-success alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            <h4> <i class="icon fa fa-check"></i>
              ${infomsg}
            </h4>
          </div>
        </#if>
        <!-- 提示框 END -->
        <form action="" class="form-horizontal"  method="post" id="form1">
          <input type="hidden" name="step" value="1">
          <input type="hidden" name="pid" value="">

          <div class="box">
            <div class="box-header with-border">
              <h3 class="box-title">${subtitle!}</h3>
            </div>
            <div class="box-body">
              <div id="step1">
                <div class="form-group">
                  <label for="input1" class="col-sm-2 control-label">公众号名称：</label>
                  <div class="col-sm-8">
                    <input type="text" name="publicname" class="form-control" id="input1" placeholder="请正确填写，否则无法收到信息" value=""></div>
                  <div class="col-sm-2"></div>
                </div>
                <div class="form-group">
                  <label for="input1" class="col-sm-2 control-label">原始ID：</label>

                  <div class="col-sm-8">
                    <input type="text" name="publicid" class="form-control" id="input1" placeholder="请正确填写，否则无法收到信息" value=""></div>
                  <div class="col-sm-2"></div>
                </div>
                <div class="form-group">
                  <label for="input1" class="col-sm-2 control-label">微信号：</label>
                  <div class="col-sm-8">
                    <input type="text" name="wechat" class="form-control" id="input1" placeholder="请正确填写，否则无法收到信息" value=""></div>
                  <div class="col-sm-2"></div>
                </div>
              </div>
              <div id="step2" style="display: none;">
                <div class="divider15"></div>
                <div class="col-sm-2">                  
                </div>
                <div class="col-sm-8">
                <p style="font-size: 16px;font-weight:bold;">请在公众平台开发者中心里的服务器配置录入以下参数</p>
                <p>URL(服务器地址)： <span id="msgurl" style="color: red;"></span></p>
                <p>Token(令牌)：<span style="color: red;">moewxms</span></p>
                <p>EncodingAESKey(消息加解密密钥)：点击随机生成得到密钥，不需要自己填写</p>
                <p>消息加解密方式： 根据自己的需要选择其中一种</p>
                </div>
                <div class="col-sm-2"></div>
                <div class="divider15"></div>
              </div>
              <div id="step3" style="display: none;">
                <div class="form-group">
                  <label for="input1" class="col-sm-2 control-label">AppID：</label>
                  <div class="col-sm-8">
                    <input type="text" name="appid" class="form-control" id="input1" placeholder="应用ID" value=""></div>
                  <div class="col-sm-2"></div>
                </div>
                <div class="form-group">
                  <label for="input1" class="col-sm-2 control-label">AppSecret：</label>

                  <div class="col-sm-8">
                    <input type="text" name="appsecret" class="form-control" id="input1" placeholder="应用密钥" value=""></div>
                  <div class="col-sm-2"></div>
                </div>
                <div class="form-group">
                  <label for="input1" class="col-sm-2 control-label">EncodingAESKey：</label>
                  <div class="col-sm-8">
                    <input type="text" name="encodingaeskey" class="form-control" id="input1" placeholder="安全模式下必填" value=""></div>
                  <div class="col-sm-2"></div>
                </div>
              </div>
            </div>
            <div class="box-footer">
              <div class="col-sm-9">
              <a id="indexbtn" href="${ctxroot}/weixin/index/list" class="btn btn-default pull-right">返回</a>
              <button id="prevbtn" type="button" class="btn btn-info pull-right" style="display: none;" onclick="prev();">上一步</button>
              
          </div>
          <div class="col-sm-1">
            <button id="nextbtn" type="button" class="btn btn-info pull-right" onclick="next();">下一步</button>
            <button id="submitbtn" type="button" style="display: none;" class="btn btn-info pull-right" onclick="saveform();">保存</button>
          </div>
          <div class="col-sm-2"></div>
        </div>
      </div>
    </form>
  </div>
  <div class="col-md-1"></div>
</div>

<!-- 下拉菜单START -->
<div id="menuContent" class="menuContent" style="display:none; position: absolute;">
  <ul id="treeDemo" class="ztree" style=""></ul>
</div>
<!-- 下拉菜单END -->
</section>
<!-- /.content -->
</div>
<!-- /.content-wrapper -->

<#include "/views/common/footer.html">

<!-- Control Sidebar -->

<!-- /.control-sidebar -->
<!-- Add the sidebar's background. This div must be placed
       immediately after the control sidebar -->
<div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.3 -->
<script src="${ctxroot}/static/plugins/jQuery/jquery-2.2.3.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="${ctxroot}/static/bootstrap/js/bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="${ctxroot}/static/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="${ctxroot}/static/plugins/fastclick/fastclick.js"></script>
<!-- DataTables -->
<script src="${ctxroot}/static/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="${ctxroot}/static/plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- ztree -->
<script type="text/javascript" src="${ctxroot}/static/plugins/ztree/js/jquery.ztree.all.min.js"></script>
<!-- Alert -->
<script type="text/javascript" src="${ctxroot}/static/plugins/Alert/Alert.js"></script>
<!-- AdminLTE App -->
<script src="${ctxroot}/static/dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="${ctxroot}/static/dist/js/demo.js"></script>
<script src="${ctxroot}/static/qxms/js/menu.js"></script>
<script type="text/javascript">
  //menu_active('10002,10004');
    $(document).ready(function(){
      // var appid = $("input[name='appid']").val();
      // var appsecret = $("input[name='appsecret']").val();
      // var encodingaeskey = $("input[name='encodingaeskey']").val();
      // var publicname = $("input[name='publicname']").val();
      // var publicid = $("input[name='publicid']").val();
      // var wechat = $("input[name='wechat']").val();


    });

    function next() {
      var step = $("input[name='step']").val();

      if(step == 1){
        //第一步
        //先验证表单
        var publicname = $("input[name='publicname']").val();
        var publicid = $("input[name='publicid']").val();
        var wechat = $("input[name='wechat']").val();

        if(publicname == ''){
          Alert("公众号名称不能为空");
        }else if(publicid == ''){
          Alert("原始ID不能为空");
        }else if(wechat == ''){
          Alert("微信号不能为空");
        }else{
          var url = actionurl + "/index/yzpublicid";
          $.post(url, {"publicid" : publicid}, function(data){
            if(data == 0){
              $("input[name='step']").val(2);
              var pid = $("input[name='pid']").val();   
              if(pid == ''){
                var url = actionurl + "/index/getpid";
                $.post(url, {}, function(data) {
                  var obj = $.parseJSON(data);          
                  $("input[name='pid']").val(obj.id);  
                  $("#msgurl").html(obj.msgurl);
                });
              }

              $("#step1").css("display","none");
              $("#step2").css("display","block");
              $("#indexbtn").css("display","none");
              $("#prevbtn").css("display","block");  
            }else{
              Alert("原始ID已经存在，请不要重复录入。");
            }
          });       
        }
      }else if(step == 2){
        //第二步
        $("input[name='step']").val(3);
        $("#step2").css("display","none");
        $("#step3").css("display","block");
        $("#submitbtn").css("display","block");
        $("#nextbtn").css("display","none");
      }else if(step == 3){

      }

    }

    function prev() {
      var step = $("input[name='step']").val();

      if(step == 2){
        $("input[name='step']").val(1);
        $("#indexbtn").css("display","block");
        $("#prevbtn").css("display","none");
        $("#step2").css("display","none");
        $("#step1").css("display","block");        
      }else if(step == 3){
        $("input[name='step']").val(2);
        $("#step3").css("display","none");
        $("#step2").css("display","block");  
        $("#submitbtn").css("display","none");
        $("#nextbtn").css("display","block");
      }


    }


    //表单提交
    function saveform(){
      //验证表单
      var pid = $("input[name='pid']").val();
      var appid = $("input[name='appid']").val();
      var appsecret = $("input[name='appsecret']").val();
      var encodingaeskey = $("input[name='encodingaeskey']").val();
      var publicname = $("input[name='publicname']").val();
      var publicid = $("input[name='publicid']").val();
      var wechat = $("input[name='wechat']").val();

      if(appid == ''){
        Alert("AppID不能为空");
      }else if(appsecret == ''){
        Alert("AppSecret不能为空");
      }else{
        //ajax提交
        var url = actionurl + "/index/savepiblic";
        $.post(url, {
          "pid":pid,
          "appid":appid,
          "appsecret":appsecret,
          "encodingaeskey":encodingaeskey,
          "publicname":publicname,
          "publicid":publicid,
          "wechat":wechat
        }, function(data){
          if(data == 1){
            Alert();
          }else{

          }
        });
      }

    };

  </script>
</body>
</html>